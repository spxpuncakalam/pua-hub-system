import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
} from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc } from 'firebase/firestore';

// --- Firebase Configuration ---
// Using the configuration you provided.
const firebaseConfig = {  
    apiKey: "AIzaSyABPOtifWKQaera7AragOseptGw_-CnFJA",  
    authDomain: "spx-puncak-alam-hub.firebaseapp.com",  
    projectId: "spx-puncak-alam-hub",  
    storageBucket: "spx-puncak-alam-hub.appspot.com", // Corrected storageBucket name
    messagingSenderId: "893783079973",  
    appId: "1:893783079973:web:8a09df2ee640c02a3d93cc",  
    measurementId: "G-24041L1LWL"  
};  

// --- Initialize Firebase and Services ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [userData, setUserData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [isRegistering, setIsRegistering] = useState(false);
    
    // --- Authentication State Observer ---
    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                // User is signed in.
                setUser(currentUser);
                // Fetch user role from Firestore
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    setUserData(userDoc.data());
                } else {
                    // Handle case where user exists in Auth but not in Firestore
                    console.log("No such user document in Firestore!");
                    setUserData({ role: 'Unknown' });
                }
            } else {
                // User is signed out.
                setUser(null);
                setUserData(null);
            }
            setLoading(false);
        });

        // Cleanup subscription on unmount
        return () => unsubscribe();
    }, []);

    // --- Render Logic ---
    if (loading) {
        return <LoadingSpinner />;
    }

    if (!user) {
        return (
            <div className="bg-gray-100 min-h-screen flex flex-col items-center justify-center font-sans">
                <div className="w-full max-w-md p-8">
                    <div className="bg-white shadow-2xl rounded-2xl p-8">
                        {isRegistering ? (
                            <RegisterScreen setIsRegistering={setIsRegistering} />
                        ) : (
                            <LoginScreen setIsRegistering={setIsRegistering} />
                        )}
                    </div>
                     <p className="text-center text-gray-500 text-xs mt-6">
                        &copy;2024 SPX Puncak Alam Hub. All rights reserved.
                    </p>
                </div>
            </div>
        );
    }

    return <PortalScreen user={user} userData={userData} />;
}

// --- Authentication Screens ---
const LoginScreen = ({ setIsRegistering }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // onAuthStateChanged will handle the rest
        } catch (err) {
            setError(getFriendlyErrorMessage(err.code));
        }
    };

    return (
        <div>
            <h2 className="text-3xl font-bold text-center text-gray-800 mb-2">Welcome Back!</h2>
            <p className="text-center text-gray-500 mb-8">Sign in to continue</p>
            {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</p>}
            <form onSubmit={handleLogin}>
                <div className="mb-4">
                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">
                        Email Address
                    </label>
                    <input
                        id="email"
                        type="email"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        placeholder="you@example.com"
                        className="shadow-inner appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div className="mb-6">
                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                        Password
                    </label>
                    <input
                        id="password"
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        placeholder="••••••••"
                        className="shadow-inner appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div className="flex items-center justify-between">
                    <button
                        type="submit"
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-transform transform hover:scale-105"
                    >
                        Sign In
                    </button>
                </div>
            </form>
            <p className="text-center text-gray-600 mt-6">
                Don't have an account?{' '}
                <button onClick={() => setIsRegistering(true)} className="font-bold text-blue-600 hover:text-blue-800">
                    Register
                </button>
            </p>
        </div>
    );
};

const RegisterScreen = ({ setIsRegistering }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [role, setRole] = useState('Sorter'); // Default role
    const [error, setError] = useState('');

    const handleRegister = async (e) => {
        e.preventDefault();
        setError('');
        if (password.length < 6) {
            setError("Password must be at least 6 characters long.");
            return;
        }
        try {
            // 1. Create user in Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. Store user role in Firestore
            await setDoc(doc(db, "users", user.uid), {
                email: user.email,
                role: role,
                createdAt: new Date()
            });
            // onAuthStateChanged will handle navigation to the portal
        } catch (err) {
            setError(getFriendlyErrorMessage(err.code));
        }
    };

    return (
        <div>
            <h2 className="text-3xl font-bold text-center text-gray-800 mb-2">Create Account</h2>
            <p className="text-center text-gray-500 mb-8">Get started with the portal</p>
            {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</p>}
            <form onSubmit={handleRegister}>
                <div className="mb-4">
                     <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-email">
                        Email Address
                    </label>
                    <input
                        id="reg-email"
                        type="email"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        placeholder="you@example.com"
                        className="shadow-inner appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div className="mb-4">
                     <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="reg-password">
                        Password
                    </label>
                    <input
                        id="reg-password"
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        placeholder="•••••••• (min. 6 characters)"
                        className="shadow-inner appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div className="mb-6">
                    <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="role">
                        Select Your Role
                    </label>
                    <select
                        id="role"
                        value={role}
                        onChange={(e) => setRole(e.target.value)}
                        className="shadow-inner border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                    >
                        <option value="Sorter">Sorter</option>
                        <option value="Supervisor">Supervisor</option>
                    </select>
                </div>
                <button
                    type="submit"
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-transform transform hover:scale-105"
                >
                    Register
                </button>
            </form>
            <p className="text-center text-gray-600 mt-6">
                Already have an account?{' '}
                <button onClick={() => setIsRegistering(false)} className="font-bold text-blue-600 hover:text-blue-800">
                    Sign In
                </button>
            </p>
        </div>
    );
};

// --- Portal Screen (after login) ---
const PortalScreen = ({ user, userData }) => {
    const handleLogout = async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Error signing out: ", error);
        }
    };

    return (
        <div className="bg-gray-100 min-h-screen">
            <header className="bg-white shadow-md">
                <nav className="container mx-auto px-6 py-4 flex justify-between items-center">
                    <div className="text-xl font-bold text-gray-800">SPX Portal</div>
                    <button 
                        onClick={handleLogout}
                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors"
                    >
                        Logout
                    </button>
                </nav>
            </header>
            <main className="container mx-auto px-6 py-12">
                <div className="bg-white p-8 rounded-2xl shadow-xl max-w-2xl mx-auto">
                    <h1 className="text-3xl font-bold text-gray-800 mb-4">Dashboard</h1>
                    <p className="text-lg text-gray-600 mb-6">Welcome to the Puncak Alam Hub Portal.</p>
                    <div className="border-t border-gray-200 pt-6">
                        <dl className="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2">
                            <div className="sm:col-span-1">
                                <dt className="text-sm font-medium text-gray-500">Email Address</dt>
                                <dd className="mt-1 text-sm text-gray-900">{user.email}</dd>
                            </div>
                            <div className="sm:col-span-1">
                                <dt className="text-sm font-medium text-gray-500">User Role</dt>
                                <dd className="mt-1 text-sm font-bold text-blue-600">{userData?.role || 'Loading...'}</dd>
                            </div>
                             <div className="sm:col-span-2">
                                <dt className="text-sm font-medium text-gray-500">User ID</dt>
                                <dd className="mt-1 text-sm text-gray-900 break-all">{user.uid}</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </main>
        </div>
    );
};

// --- Helper Components & Functions ---
const LoadingSpinner = () => (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-blue-600"></div>
    </div>
);

const getFriendlyErrorMessage = (code) => {
    switch (code) {
        case 'auth/user-not-found':
            return 'No account found with this email. Please register first.';
        case 'auth/wrong-password':
            return 'Incorrect password. Please try again.';
        case 'auth/email-already-in-use':
            return 'This email is already registered. Please log in.';
        case 'auth/weak-password':
            return 'Password is too weak. It should be at least 6 characters.';
        case 'auth/invalid-email':
            return 'Please enter a valid email address.';
        default:
            return 'An unexpected error occurred. Please try again.';
    }
};
