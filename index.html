<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopee Express Hub Management System</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS/xlsx library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        /* Custom styles to enhance the UI */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        /* Custom scrollbar for the table */
        .table-container {
            max-height: 60vh; /* Set a max height for the table container */
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #fb923c; /* Shopee Orange */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Sticky header for table */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Application Container -->
    <div id="app-container">

        <!-- Initial Loading View -->
        <div id="loading-view" class="min-h-screen flex flex-col items-center justify-center bg-gray-100">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">Authenticating and loading system...</p>
        </div>

        <!-- Main Application View (Dashboard) -->
        <div id="app-view" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow-md sticky top-0 z-40">
                <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <img src="https://placehold.co/40x40/F97316/FFFFFF?text=SPX" alt="Logo" class="h-8 w-auto rounded-full">
                            <h1 class="ml-3 text-xl font-bold text-gray-800">Hub Dashboard</h1>
                        </div>
                        <div class="flex items-center">
                            <div class="text-right mr-4">
                                <p id="user-id" class="text-sm font-medium text-gray-800" title="Full User ID"></p>
                                <p id="user-role" class="text-xs text-gray-500 capitalize"></p>
                            </div>
                            <button id="logout-button" title="Logout" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                                <span class="material-symbols-outlined">logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="p-4 sm:p-6 lg:p-8">
                <!-- Upload Section -->
                <div id="upload-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Inbound Parcel Data</h2>
                    <div class="flex items-center space-x-4">
                        <label for="file-upload" class="cursor-pointer bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors duration-200 flex items-center">
                            <span class="material-symbols-outlined mr-2">upload_file</span>
                            Choose Excel/CSV File
                        </label>
                        <input id="file-upload" type="file" class="hidden" accept=".xlsx, .xls, .csv">
                        <span id="file-name" class="text-gray-600">No file chosen</span>
                    </div>
                    <div id="upload-status" class="mt-4 text-sm"></div>
                </div>

                <!-- Data View Section -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Parcel Overview</h2>
                    
                    <!-- Filter Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <input id="search-filter" type="text" placeholder="ðŸ” Search by any field..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                        <input id="driver-filter" type="text" placeholder="Filter by Driver Name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                        <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                            <option value="">All Statuses</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>

                    <!-- Data Table -->
                    <div id="table-container" class="overflow-auto table-container">
                        <p id="loading-state" class="text-center py-8 text-gray-500">Loading parcel data...</p>
                        <table id="parcel-table" class="min-w-full divide-y divide-gray-200 hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <!-- Table headers will be populated dynamically -->
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be populated dynamically -->
                            </tbody>
                        </table>
                         <p id="no-data-state" class="text-center py-8 text-gray-500 hidden">No parcels found. Try uploading a file or adjusting your filters.</p>
                    </div>
                </div>
            </main>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & CONSTANTS ---
        const loadingView = document.getElementById('loading-view');
        const appView = document.getElementById('app-view');
        const logoutButton = document.getElementById('logout-button');
        const userIdEl = document.getElementById('user-id');
        const userRoleEl = document.getElementById('user-role');
        const fileUpload = document.getElementById('file-upload');
        const fileNameEl = document.getElementById('file-name');
        const uploadStatusEl = document.getElementById('upload-status');
        const parcelTable = document.getElementById('parcel-table');
        const noDataState = document.getElementById('no-data-state');
        const searchFilter = document.getElementById('search-filter');
        const driverFilter = document.getElementById('driver-filter');
        const statusFilter = document.getElementById('status-filter');
        const loadingState = document.getElementById('loading-state');
        
        // State management
        let currentUser = null;
        let allParcels = [];
        let parcelHeaders = [];
        let unsubscribeParcels = null; // To store the onSnapshot listener

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        try {
            // Get app ID and Firebase config from environment variables provided by the platform
            let appId = typeof __app_id !== 'undefined' ? __app_id : 'github-pages-app'; // Default appId for GitHub Pages
            let firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // If firebaseConfig is not provided by the environment, use a hardcoded one for GitHub Pages.
            if (!firebaseConfigStr) {
                console.warn("Firebase configuration not found in environment. Using hardcoded configuration for GitHub Pages.");
                firebaseConfigStr = JSON.stringify({
                    apiKey: "AIzaSyABPOtifWKQaera7AragOseptGw_-CnFJA",
                    authDomain: "spx-puncak-alam-hub.firebaseapp.com",
                    projectId: "spx-puncak-alam-hub",
                    storageBucket: "spx-puncak-alam-hub.firebasestorage.app",
                    messagingSenderId: "893783079973",
                    appId: "1:893783079973:web:8a09df2ee640c02a3d93cc",
                    measurementId: "G-24041L1LWL"
                });
            }

            const firebaseConfig = JSON.parse(firebaseConfigStr);

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- AUTHENTICATION HANDLER ---
            const handleAuthentication = async () => {
                try {
                    // Use custom token if available, otherwise sign in anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    loadingView.innerHTML = `<p class="text-red-600">Authentication failed: ${error.message}. Check your Firebase configuration and security rules.</p>`;
                }
            };

            // --- AUTH STATE LISTENER ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in.
                    currentUser = user;
                    const userId = user.uid;
                    
                    // Get or create user profile in Firestore
                    const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                    let userDoc = await getDoc(userDocRef);
                    let userData = { role: 'sorter', createdAt: new Date().toISOString() }; // Default role

                    if (!userDoc.exists()) {
                        try {
                            await setDoc(userDocRef, userData);
                        } catch (e) {
                            console.error("Error creating user profile:", e);
                        }
                    } else {
                        userData = userDoc.data();
                    }
                    
                    // Update UI with user info
                    userIdEl.textContent = `User: ${userId.substring(0, 12)}...`;
                    userIdEl.title = `Full User ID: ${userId}`;
                    userRoleEl.textContent = `Role: ${userData.role}`;
                    
                    // Show the main application and hide loading screen
                    loadingView.classList.add('hidden');
                    appView.classList.remove('hidden');

                    // Start listening for parcel data changes
                    listenForParcels();

                } else {
                    // User is signed out. Attempt to sign in.
                    currentUser = null;
                    if (unsubscribeParcels) {
                        unsubscribeParcels(); // Stop listening to old data
                    }
                    await handleAuthentication();
                }
            });
            
            // --- LOGOUT ---
            logoutButton.addEventListener('click', async () => {
                await signOut(auth);
                // onAuthStateChanged will handle the UI change and re-authentication
                window.location.reload(); // Easiest way to reset all state
            });

            // --- FILE UPLOAD & PROCESSING ---
            fileUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                fileNameEl.textContent = file.name;
                uploadStatusEl.innerHTML = `<p class="text-blue-600">Processing file...</p>`;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json_data = XLSX.utils.sheet_to_json(worksheet);

                        if (json_data.length === 0) {
                            uploadStatusEl.innerHTML = `<p class="text-red-600">File is empty or format is incorrect.</p>`;
                            return;
                        }
                        
                        uploadStatusEl.innerHTML = `<p class="text-blue-600">Found ${json_data.length} records. Uploading to database... This may take a moment.</p>`;

                        // Use writeBatch for atomic bulk operations
                        const batch = writeBatch(db);
                        let count = 0;

                        json_data.forEach(row => {
                            // Find a unique identifier for the parcel
                            const orderSN = row['Shopee Order SN'] || row['Order ID'] || row['SLS Tracking Number'] || crypto.randomUUID();
                            
                            // Sanitize row data to ensure all values are storable in Firestore
                            const sanitizedRow = Object.fromEntries(
                                Object.entries(row).map(([key, value]) => {
                                    // Sanitize key by removing characters not allowed in Firestore field paths
                                    const sanitizedKey = key.replace(/[.*[\]]/g, '');
                                    // Convert value to string to avoid data type issues
                                    const sanitizedValue = value === null || value === undefined ? '' : String(value);
                                    return [sanitizedKey, sanitizedValue];
                                })
                            );

                            const parcelRef = doc(db, 'artifacts', appId, 'public', 'data', 'parcels', String(orderSN));
                            batch.set(parcelRef, sanitizedRow, { merge: true }); // Use merge to update/create
                            count++;
                        });

                        await batch.commit();
                        uploadStatusEl.innerHTML = `<p class="text-green-600">Successfully uploaded and processed ${count} parcel records.</p>`;
                    
                    } catch (error) {
                        console.error("File processing error:", error);
                        uploadStatusEl.innerHTML = `<p class="text-red-600">Error processing file. Make sure it's a valid Excel/CSV file. Details: ${error.message}</p>`;
                    } finally {
                        fileUpload.value = ''; // Reset file input
                        setTimeout(() => {
                           uploadStatusEl.innerHTML = '';
                           fileNameEl.textContent = 'No file chosen';
                        }, 5000);
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // --- DATA FETCHING & RENDERING ---
            function listenForParcels() {
                if (unsubscribeParcels) unsubscribeParcels(); // Unsubscribe from previous listener if it exists

                const parcelsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'parcels');
                unsubscribeParcels = onSnapshot(parcelsColRef, (snapshot) => {
                    loadingState.classList.add('hidden');
                    allParcels = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

                    if (allParcels.length > 0) {
                        // Dynamically determine headers from all parcels to be comprehensive
                        const headersSet = new Set();
                        allParcels.forEach(p => Object.keys(p).forEach(k => headersSet.add(k)));
                        parcelHeaders = Array.from(headersSet).sort(); // Sort headers alphabetically
                        
                        renderTableHeaders();
                        populateStatusFilter();
                    }
                    renderTable(); // Render table with new data
                }, (error) => {
                    console.error("Error fetching parcels:", error);
                    loadingState.textContent = "Error loading data. Check console for details.";
                    noDataState.classList.remove('hidden');
                    noDataState.textContent = "Error loading data. You may not have permission to view this data.";
                });
            }

            function renderTableHeaders() {
                const thead = parcelTable.querySelector('thead tr');
                thead.innerHTML = '';
                parcelHeaders.forEach(header => {
                    if (header === 'id') return; // Don't show the document ID as a column
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50';
                    th.textContent = header.replace(/_/g, ' ');
                    thead.appendChild(th);
                });
            }

            function renderTable() {
                const tbody = parcelTable.querySelector('tbody');
                tbody.innerHTML = '';

                const searchVal = searchFilter.value.toLowerCase();
                const driverVal = driverFilter.value.toLowerCase();
                const statusVal = statusFilter.value;

                const filteredParcels = allParcels.filter(parcel => {
                    const driverName = (parcel['Driver Name'] || '').toLowerCase();
                    const status = parcel['Status'] || '';
                    
                    const matchesDriver = driverVal ? driverName.includes(driverVal) : true;
                    const matchesStatus = statusVal ? status === statusVal : true;
                    const matchesSearch = searchVal ? Object.values(parcel).some(val => 
                        String(val).toLowerCase().includes(searchVal)
                    ) : true;
                    
                    return matchesDriver && matchesStatus && matchesSearch;
                });

                if (filteredParcels.length === 0) {
                    parcelTable.classList.add('hidden');
                    noDataState.classList.remove('hidden');
                    noDataState.textContent = allParcels.length > 0 ? "No parcels match your current filters." : "No parcels found. Try uploading a file.";
                } else {
                    parcelTable.classList.remove('hidden');
                    noDataState.classList.add('hidden');
                }

                filteredParcels.forEach(parcel => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-orange-50 transition-colors duration-150';
                    parcelHeaders.forEach(header => {
                        if (header === 'id') return; // Don't render the ID cell
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                        td.textContent = parcel[header] || 'N/A';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
            
            function populateStatusFilter() {
                if (allParcels.length === 0 || !parcelHeaders.includes('Status')) return;
                
                const statuses = [...new Set(allParcels.map(p => p.Status).filter(Boolean))];
                statuses.sort();
                
                const currentVal = statusFilter.value;
                statusFilter.innerHTML = '<option value="">All Statuses</option>';
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                });
                statusFilter.value = currentVal;
            }

            // --- EVENT LISTENERS FOR FILTERS ---
            searchFilter.addEventListener('input', renderTable);
            driverFilter.addEventListener('input', renderTable);
            statusFilter.addEventListener('change', renderTable);

        } catch (e) {
            console.error("Fatal Error:", e.message);
            loadingView.innerHTML = `<p class="text-red-600 font-bold">${e.message}</p>`;
        }
    </script>
</body>
</html>
